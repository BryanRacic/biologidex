================================================================================
                    DEX SYSTEM - ARCHITECTURE DIAGRAM
================================================================================

CURRENT STATE (Single-user, local-only)
───────────────────────────────────────────────────────────────────────────────

┌─────────────────────────────────────────────────────────────────────────────┐
│ GODOT CLIENT (Web)                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │ LOCAL STORAGE (user:// filesystem)                                  │ │
│  │                                                                      │ │
│  │  user://dex_database.json                                          │ │
│  │  {                                                                  │ │
│  │    123: {sci_name, common_name, image_path},                      │ │
│  │    124: {sci_name, common_name, image_path}                       │ │
│  │  }                                                                  │ │
│  │                                                                      │ │
│  │  user://dex_cache/                                                 │ │
│  │  ├─ hash1.png                                                      │ │
│  │  ├─ hash2.png                                                      │ │
│  │  └─ ...                                                             │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐        │
│  │   camera.gd      │  │    dex.gd        │  │   DexService     │        │
│  │                  │  │                  │  │                  │        │
│  │ 1. Select photo  │  │ 1. Load local DB │  │ 1. API requests  │        │
│  │ 2. Upload → CV   │  │ 2. Display by    │  │ 2. Response      │        │
│  │ 3. Poll job      │  │    creation_idx  │  │    parsing       │        │
│  │ 4. Download img  │  │ 3. Next/Prev nav │  │ 3. Error         │        │
│  │ 5. Cache locally │  │ 4. Show record   │  │    handling      │        │
│  │ 6. Save to DB    │  │                  │  │                  │        │
│  └────────┬─────────┘  └──────────────────┘  └──────────────────┘        │
│           │ (saves entry)                                                  │
│           v                                                                │
│       DexDatabase                                                          │
│       (singleton)                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
         ↑                                    ↓
         │ reads from                         │ calls
         │                                    │
         └────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ DJANGO BACKEND (REST API)                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  POST /dex/entries/              Create new entry                         │
│  GET  /dex/entries/my_entries/   Get own entries                          │
│  GET  /dex/entries/sync_entries/ Sync with last_sync timestamp            │
│  GET  /dex/entries/favorites/    Get favorites                            │
│  POST /dex/entries/{id}/toggle_  Toggle favorite status                   │
│       favorite/                                                             │
│  GET  /dex/entries/recent/       Get recent from friends                  │
│  GET  /dex/entries/by_animal/    Get all entries for animal               │
│  ❌   /dex/user/{id}/entries/    MISSING: Friend dex endpoint             │
│                                                                             │
│  Serializers:                                                              │
│  ├─ DexEntrySerializer ............ Full detail                           │
│  ├─ DexEntryListSerializer ........ Lightweight                           │
│  ├─ DexEntrySyncSerializer ........ With checksums & URLs                │
│  ├─ DexEntryCreateSerializer ...... For POST                              │
│  └─ DexEntryUpdateSerializer ...... For PATCH                             │
│                                                                             │
│  Database:                                                                 │
│  ├─ DexEntry                                                              │
│  │  ├─ owner (FK to User)                                                │
│  │  ├─ animal (FK to Animal)                                             │
│  │  ├─ original_image (file)                                             │
│  │  ├─ processed_image (file)                                            │
│  │  ├─ source_vision_job (FK to AnalysisJob with dex_compatible_image) │
│  │  ├─ visibility (private/friends/public)                              │
│  │  ├─ catch_date                                                        │
│  │  ├─ is_favorite                                                       │
│  │  ├─ created_at / updated_at                                           │
│  │  └─ location, notes, customizations                                   │
│  │                                                                         │
│  └─ Animal                                                                │
│     ├─ creation_index (auto-increment, Pokedex #)                        │
│     ├─ scientific_name                                                   │
│     ├─ common_name                                                       │
│     ├─ Full taxonomic hierarchy                                          │
│     └─ ...                                                               │
│                                                                             │
│  Permissions:                                                              │
│  └─ IsOwnerOrReadOnly                                                     │
│     ├─ public entries: everyone can read                                 │
│     ├─ friends entries: friends can read, owner can write                │
│     ├─ private entries: owner only                                       │
│     └─ Write: owner only                                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


PROBLEM: No way to view friend's dex
─────────────────────────────────────

Friend Selection ❌  →  Friend Dex Endpoint ❌  →  Per-user Cache ❌


================================================================================
                        DESIRED STATE (Multi-user with sync)
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ GODOT CLIENT (Web)                                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │ LOCAL STORAGE (user:// filesystem) - REFACTORED                    │ │
│  │                                                                      │ │
│  │  Own Dex:                                                           │ │
│  │  ├─ user://dex_database.json (my entries)                          │ │
│  │  ├─ user://dex_cache/own/hash1.png                                 │ │
│  │  └─ user://dex_cache/own/hash2.png                                 │ │
│  │                                                                      │ │
│  │  Friend 1 Dex:                                                      │ │
│  │  ├─ user://dex_database_friend_uuid1.json                          │ │
│  │  ├─ user://dex_cache/friend_uuid1/hash1.png                        │ │
│  │  └─ user://dex_cache/friend_uuid1/hash2.png                        │ │
│  │                                                                      │ │
│  │  Friend 2 Dex:                                                      │ │
│  │  ├─ user://dex_database_friend_uuid2.json                          │ │
│  │  ├─ user://dex_cache/friend_uuid2/hash1.png                        │ │
│  │  └─ user://dex_cache/friend_uuid2/hash2.png                        │ │
│  │                                                                      │ │
│  │  Sync State:                                                        │ │
│  │  ├─ user://sync_state.json                                         │ │
│  │  │  {                                                              │ │
│  │  │    "own": {last_sync: "2025-11-10T..."},                        │ │
│  │  │    "friend_uuid1": {last_sync: "2025-11-10T..."},               │ │
│  │  │    "friend_uuid2": {last_sync: "2025-11-10T..."}                │ │
│  │  │  }                                                              │ │
│  │  └─ Stored in TokenManager or SyncManager                          │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ UI LAYERS                                                           │ │
│  │                                                                     │ │
│  │  dex.gd (ENHANCED)                                                │ │
│  │  ├─ Friend selector: [My Dex] [Friend 1] [Friend 2] [+]           │ │
│  │  ├─ Current viewing_user tracking (separate from logged_in_user)  │ │
│  │  ├─ Previous/Next navigation (per dex)                            │ │
│  │  ├─ Sync progress indicator (X of Y downloaded)                   │ │
│  │  ├─ Empty state (per dex)                                         │ │
│  │  └─ Real-time updates on sync complete                            │ │
│  │                                                                     │ │
│  │  camera.gd (ENHANCED)                                             │ │
│  │  ├─ Auto-sync on image save                                       │ │
│  │  ├─ Track last_sync timestamp                                     │ │
│  │  └─ Update own dex local storage                                  │ │
│  │                                                                     │ │
│  │  SyncManager (NEW)                                                │ │
│  │  ├─ Track last_sync per user/friend                               │ │
│  │  ├─ Manage sync state (idle→syncing→complete→error)              │ │
│  │  ├─ Progress tracking (current/total)                             │ │
│  │  ├─ Retry logic on failure                                        │ │
│  │  └─ Resume interrupted downloads                                  │ │
│  │                                                                     │ │
│  │  DexService (ENHANCED)                                            │ │
│  │  ├─ sync_entries(user_id, last_sync) ← fixed bug                 │ │
│  │  ├─ get_friend_entries(friend_id) ← NEW                           │ │
│  │  ├─ download_dex_images(entries) ← NEW                            │ │
│  │  └─ Error handling & retry                                        │ │
│  │                                                                     │ │
│  │  DexDatabase (REFACTORED)                                         │ │
│  │  ├─ Static method: load_user_dex(user_id)                         │ │
│  │  ├─ Separate instances per user                                   │ │
│  │  ├─ get_next_index() / get_previous_index()                       │ │
│  │  └─ Per-user sorted indices                                       │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│ DJANGO BACKEND (REST API) - ENHANCED                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Existing Endpoints:                                                       │
│  ├─ GET/POST /dex/entries/ ✅                                              │
│  ├─ GET /dex/entries/my_entries/ ✅                                        │
│  ├─ GET /dex/entries/sync_entries/ ✅ (returns "entries" key)             │
│  ├─ GET /dex/entries/favorites/ ✅                                         │
│  ├─ POST /dex/entries/{id}/toggle_favorite/ ✅                            │
│  ├─ GET /dex/entries/recent/ ✅                                            │
│  └─ GET /dex/entries/by_animal/ ✅                                         │
│                                                                             │
│  NEW Endpoint:                                                             │
│  └─ GET /dex/user/{user_id}/entries/ ← CRITICAL                           │
│     ├─ Returns entries respecting visibility                              │
│     ├─ Respects friendship (friends/public for friends, just public)     │
│     ├─ Returns with creation_index from animal                            │
│     ├─ Returns dex_compatible_url for each entry                          │
│     └─ Returns image_checksum & image_updated_at                          │
│                                                                             │
│  Optional Enhancements:                                                    │
│  ├─ Pagination for large dex                                              │
│  ├─ Sorting/filtering options                                             │
│  ├─ Sync metadata (total_count, last_sync_server_time)                   │
│  └─ Batch endpoint for multiple friends                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


DATA FLOW EXAMPLES
───────────────────────────────────────────────────────────────────────────────

Scenario 1: User opens their own dex on app launch
─────────────────────────────────────────────────────────

1. home.gd detects app launch
2. SyncManager.sync_all_user_dex() called
3. DexService.sync_entries(owner_id, last_sync_own)
4. Server: /dex/entries/sync_entries/?last_sync=...
5. Server returns changed entries since last_sync
6. Client downloads images for new/changed entries
7. Store images in user://dex_cache/own/{hash}.png
8. Update DexDatabase with new entries
9. Update last_sync timestamp in sync_state.json
10. dex.gd loads and displays updated dex

Scenario 2: User selects Friend to view their dex
──────────────────────────────────────────────────

1. User clicks friend in dex.gd friend selector
2. dex.gd calls DexService.get_friend_entries(friend_id)
3. Server: /dex/user/{friend_id}/entries/
4. Server returns friend's visible entries
5. Client checks local cache for images
6. Downloads missing/new images to user://dex_cache/friend_{id}/{hash}.png
7. Load into DexDatabase_friend_{id}
8. Update last_sync for this friend
9. dex.gd displays friend's dex
10. Next/Prev nav works within friend's entries

Scenario 3: Sync progress tracking
──────────────────────────────────

1. dex.gd shows sync progress UI: "Syncing (0/42 images)"
2. SyncManager processes each entry
3. Emits progress_updated(current, total) after each image
4. dex.gd updates label: "Syncing (15/42 images)"
5. On complete: emit sync_completed()
6. dex.gd refreshes display


COMPARISON TABLE: Current vs Desired
───────────────────────────────────────────────────────────────────────────────

Feature                          Current          Desired
────────────────────────────────────────────────────────────
View own dex                     ✅              ✅
View friend dex                  ❌              ✅
Multiple dex local storage       ❌              ✅
Sync on demand                   ⚠️ broken       ✅
Sync on app launch               ❌              ✅
Sync progress tracking           ❌              ✅
Sync retry on failure            ❌              ✅
Per-user image cache             ❌              ✅
Last sync persistence            ❌              ✅
Friend selector UI               ❌              ✅
Multi-dex navigation             ❌              ✅
Offline dex viewing              ✅              ✅
Image collision prevention       ❌              ✅


================================================================================
                      IMPLEMENTATION ORDER
================================================================================

CRITICAL PATH (Fastest way to MVP):
1. Fix sync bug (1 line)
2. Add last_sync tracking
3. Add /dex/user/{id}/entries/ endpoint
4. Refactor DexDatabase for multi-user
5. Add friend selector UI
6. Fix image cache structure

NON-CRITICAL ENHANCEMENTS (After MVP):
1. Sync progress tracking
2. Retry logic
3. Auto-sync on app launch
4. Batch endpoints
5. Performance optimization
6. Cache cleanup

================================================================================
